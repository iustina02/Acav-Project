<!DOCTYPE html>
<html> 
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>ACAV</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="./CSS/login_page.css">
        <link rel="stylesheet" href="./CSS/home_page.css">
        <link rel="stylesheet" href="./CSS/menu_page.css">
        <style type="text/css">
            .active{
                display: block;
            }
            .inactive{
                display: none;
            }
          </style>
        <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.3/dist/Chart.min.js"></script>
        <script src="http://hongru.github.io/proj/canvas2image/canvas2image.js"></script>
        <script src="https://kit.fontawesome.com/ec29ebc02d.js" crossorigin="anonymous"></script>
        <script src="https://canvasjs.com/assets/script/canvasjs.min.js"> </script>
    </head>
    <body>
        <div id="Login" href="/start_page">
            <h1>Welcome to</h1>
            <img src="https://www.graphicsprings.com/filestorage/stencils/f9283310df222811f9d9e117132d93a5.png?width=500&height=500" alt ="Acav Logo">
            <button onclick="deleteAllCookies()"><a style="text-decoration: none; color:white;"href="/login">Login</a></button>
            <br>
        </div>

        <div id="Home">
            <div class="right_menu">
                <button id="Log_out2">Log out</button>
                <img src="https://www.graphicsprings.com/filestorage/stencils/f9283310df222811f9d9e117132d93a5.png?width=500&height=500" alt ="Acav Logo">
                <div>
                    <button id="btn_top_tracks">Show</button><a href="/top_tracks">Get Tracks</a>
                </div>
                <div>
                    <button id="btn_top_artists">Show</button><a href="/top_artists">Get Artists</a>
                </div>
                <div>
                    <button id="btn_top_genres">Show</button><a href="/top_genres">Get Genres</a>
                </div>
                <!-- <button>Graph</button> -->
                <button id="Log_out"><a href="/log_out">Log out</a></button>
            </div>
            <div class="top_menu">
                <button onclick="top_menu()">⮛</button>
                <select id="gen_select">
                    <option value="0">Gen:</option>
                </select>
                <select id="location_select">
                    <option value="0">Country:</option>
                    <option value="RO">RO</option>
                    <option value="IT">IT</option>
                </select>
                <select id="hobby_selec">
                    <option value="0">Hobby:</option>
                </select>
                <a href="/search"><i  id="search_eve" class="fas fa-search"></i></a>
                <input id="search_user" placeholder="User">
                <input  id="search_artist_track" placeholder="Artist/Music">
            </div>

            <div class="main_body">
                <h1 id="user_welcome">Hello, user</h1>
                <div  class="graph">
                    <div id="chartContainer" style="height: 200px; width: 100%;"></div>
                </div>
                <a href="#Home" class="button" id="btn-download" >Download PNG</a>
                <a href="#Home" class="button" id="btn-download-svg">Download SVG</a>
            </div>

            <div class="Top_genre">
                <div id="info_div">
                    <p id="info_title">User's Spotify Name</p>
                </div>
            </div>

            <div class="groups">
                <div class="title">
                    <i class="fas fa-users"></i><button id="btn_groups" >See groups</button>
                    <a id="take_data_group" href="/groups">Take data</a>
                </div>
                <div class="list_of_groups">
                    <div class="group">
                        <p id="first_gen"></p>
                    </div>
                    <div class="group">
                        <p id="sec_gen"></p>
                    </div>
                    <div class="group">
                        <p id="thr_gen"></p>
                    </div>
                    <div class="group">
                        <p id="four_gen"></p>
                    </div>
                    <div class="group">
                        <p id="five_gen"></p>
                    </div>
                    <div class="group">
                        <p id="six_gen"></p>
                    </div>
                    <div class="group">
                        <p id="seven_gen"></p>
                    </div>
                    <div class="group">
                        <p id="eight_gen"></p>
                    </div>
                    <div class="group">
                        <p id="nine_gen"></p>
                    </div>
                    <div class="group">
                        <p id="ten_gen"></p>
                    </div>
                </div>
            </div>
        </div>

        <div id="Menu">
            <div class="right_menu">
                <button id="home_button" onclick="home()">⮛</button>
                <img src="https://www.graphicsprings.com/filestorage/stencils/f9283310df222811f9d9e117132d93a5.png?width=500&height=500" alt ="Acav Logo">
                <div>
                    <button id="btn_top_tracks">Show</button><a href="/top_tracks">Get Tracks</a>
                </div>
                <div>
                    <button id="btn_top_artists">Show</button><a href="/top_artists">Get Artists</a>
                </div>
                <div>
                    <button id="btn_top_genres">Show</button><a href="/top_genres">Get Genres</a>
                </div>
                <!-- <button>Graph</button> -->
                <button id="Log_out"><a href="/log_out">Log out</a></button>
            </div>
        </div>
    </body>
    <script src="./JS/pages.js"></script>
    <script src="./JS/chart.js"></script>
    <script src="./JS/share_graph.js"></script>
    <script src="./JS/pages2.js"></script>
    <script>

        var name = top_artists_name_cookies();
        var popularity = top_artists_popularity_cookies();

        var playlist_track_name = [];
        var playlist_track_popularity = [];

        var albums = [];
        var fans = [];

        setTimeout(3000);
        deleteAllCookies();

        var info_div = document.getElementById("info_div");
        var gen_select = document.getElementById("gen_select");
        var location_select = document.getElementById("location_select");

        var all_genres_name = [];

        var cookies_name = name.split(",");


        for(i = 0; i < cookies_name.length ; i ++){
            if(cookies_name[i] == " users_gen" || cookies_name[i] == "users_gen"){
                document.getElementById("info_title").innerHTML = "User(s) with selected genre";
                var pCreate = document.createElement('p');
                let result = popularity[i];
                result = result.replace("[","");
                result = result.replace("\"", "");
                result = result.replace("\"", "");
                result = result.replace("]","");
                pCreate.innerHTML = result;
                info_div.appendChild(pCreate);

                for(j = 0; j < cookies_name.length ; j ++){
                    if(cookies_name[j] == " users_id" || cookies_name[j] == "users_id" ){
                        let hi5 = document.createElement('p');
                        let result = popularity[j];
                        result = result.replace("[","");
                        result = result.replace("\"", "");
                        result = result.replace("\"", "");
                        result = result.replace("]","");
                        hi5.innerHTML = result;
                        info_div.appendChild(hi5);
                    }
                }
            } else if(cookies_name[i] == " users_location" || cookies_name[i] == "users_location"){
                document.getElementById("info_title").innerHTML = "User(s) with selected location";
                var pCreate = document.createElement('p');
                let result = popularity[i];
                result = result.replace("[","");
                result = result.replace("\"", "");
                result = result.replace("\"", "");
                result = result.replace("]","");
                pCreate.innerHTML = result;
                info_div.appendChild(pCreate);

                for(j = 0; j < cookies_name.length ; j ++){
                    if(cookies_name[j] == " users_id" || cookies_name[j] == "users_id" ){
                        let hi5 = document.createElement('p');
                        let result = popularity[j];
                        result = result.replace("[","");
                        result = result.replace("\"", "");
                        result = result.replace("\"", "");
                        result = result.replace("]","");
                        hi5.innerHTML = result;
                        info_div.appendChild(hi5);
                    }
                }
            } else if(cookies_name[i] == " user_name_playlist" || cookies_name[i] == "user_name_playlist"){
                document.getElementById("info_title").innerHTML = "Spotify User Playlist";
                var pCreate = document.createElement('p');
                let result = popularity[i];
                result = result.replace("[","");
                result = result.replace("\"", "");
                result = result.replace("\"", "");
                result = result.replace("]","");
                pCreate.innerHTML = result;
                info_div.appendChild(pCreate);

            }else if(cookies_name[i] == " playlist_track_pop" || cookies_name[i] == "playlist_track_pop"){
                playlist_track_popularity= popularity[i];
                
            }
            else if(cookies_name[i] == " playlist_track_name" || cookies_name[i] == "playlist_track_name"){
                playlist_track_name= popularity[i];
                
            } else if(cookies_name[i] == " error" || cookies_name[i] == "error"){
                console.log(popularity[i]);
            } else if(cookies_name[i] == "search_result" || cookies_name[i] == " search_result"){
                let result = popularity[i];
                result = result.replace("[","");
                result = result.replace("\"", "");
                result = result.replace("\"", "");
                result = result.replace("]","");

                albums = result.split(",");

                for(j = 0; j < cookies_name.length ; j ++){
                    if(cookies_name[j] == " fans" || cookies_name[j] == "fans" ){
                        let result = popularity[j];
                        fans = result.split(':')[1].replace("[]","").split(',');

                    }
                }
            }

        }


        if(playlist_track_name.length >0 && playlist_track_popularity.length >0) {
            var playlist_track_name = playlist_track_name.split(':')[1].replace("[\"]","").split(",");
            var playlist_track_popularity = playlist_track_popularity.split(":")[1].replace("[\"]","").split(",");
            makegraph(playlist_track_name,playlist_track_popularity);
        }

        if(albums.length >0 && fans.length >0) {
            makegraph(albums,fans);
        }

        if("all_genres_name" in sessionStorage) all_genres_name = sessionStorage.getItem("all_genres_name").split(',');
        

        for( i = 0; i < all_genres_name.length; i++){
            var pCreate = document.createElement('option');
            let result = all_genres_name[i];
            result = result.replace("[","");
            result = result.replace("\"", "");
            result = result.replace("\"", "");
            result = result.replace("]","");
            pCreate.innerHTML = result;
            pCreate.value = result;
            gen_select.appendChild(pCreate);

        }

        document.getElementById("search_eve").addEventListener("click", function(){
            // console.log("ceva");
            var result_gen = gen_select.options[gen_select.selectedIndex].value;
            var result_location = location_select.options[location_select.selectedIndex].value;

            if(result_gen != "0" && result_location != "0")
            {
                let result = result_gen+"/"+result_location;
                document.cookie = "data="+result;
                console.log(result);
            }
            else if(result_location != "0")
            {
                document.cookie = "data=gen/"+result_location;
            }          
            else if(result_gen != "0")
            {
                document.cookie = "data="+result_gen+"/location";
            }
            else if(input_user != null){
                console.log(input);
            }  
        })

        document.getElementById("search_user").addEventListener('keypress', function(e){
            if (e.key === 'Enter') {
                let input_user = document.getElementById("search_user").value;
                if(input_user != null){
                    document.cookie = "user="+input_user;

                    location.href = "/search_user";
                }
                else {
                    console.log("enter");
                } 
            }

        })

        document.getElementById("search_artist_track").addEventListener('keypress', function(e){
            if (e.key === 'Enter') {
                let input_user = document.getElementById("search_artist_track").value;
                if(input_user != null){
                    document.cookie = "search="+input_user;

                    location.href = "/search_artist_track";
                }
                else {
                    console.log("enter");
                } 
            }

        })

        document.getElementById("btn_top_tracks").addEventListener("click", function () {

            if (!("tracks_name" in sessionStorage)) {
                sessionStorage.setItem('tracks_name',name);
            }
            if (sessionStorage.getItem("tracks_popularity") == null) {
                sessionStorage.setItem('tracks_popularity',popularity);
            }

            let track_name = sessionStorage.getItem('tracks_name').split(',');
            let track_pop = sessionStorage.getItem("tracks_popularity").split(',');

            var chart =  new CanvasJS.Chart("chartContainer", {
            theme: "dark1", // "light2", "dark1", "dark2"
            animationEnabled: true, // change to true		
            title:{
                text: "Tracks - Popularity"
                },
                data: [
                {
                    // Change type to "bar", "area", "spline", "pie",etc.
                    type: "column",
                    dataPoints: [
                        { label: track_name[0],  y: parseInt(track_pop[0],10)},
                        { label: track_name[1], y: parseInt(track_pop[1],10)  },
                        { label: track_name[2], y: parseInt(track_pop[2],10)  },
                        { label: track_name[3],  y: parseInt(track_pop[3],10)  },
                        { label: track_name[4],  y: parseInt(track_pop[4],10)  },
                        { label: track_name[5],  y: parseInt(track_pop[5],10) },
                        { label: track_name[6], y: parseInt(track_pop[6],10)  },
                        { label: track_name[7], y: parseInt(track_pop[7],10)  },
                        { label: track_name[8],  y: parseInt(track_pop[8],10)  },
                        { label: track_name[9],  y: parseInt(track_pop[9],10)  }
                    ]
                }
                ]
            });
            chart.render();

            let fdds =  document.querySelector("div.canvasjs-chart-container a");
            fdds.setAttribute("style", "display:none;");
            
            document.getElementById("btn-download").addEventListener("click",function() {
            chart.exportChart({format: "png"});
            });

            document.getElementById("btn-download-svg").addEventListener("click",function() {
                chart.exportChart({format: "svg"});
            });

            deleteAllCookies();
            name = [];
            popularity = [];

            });

        document.getElementById("btn_top_artists").addEventListener("click", function () {

            if (!("artists_name" in sessionStorage)) {
                sessionStorage.setItem('artists_name',name);
            }
            if (sessionStorage.getItem("artists_popularity") == null) {
                sessionStorage.setItem('artists_popularity',popularity);
            }

            let art_name = sessionStorage.getItem('artists_name').split(',');
            let art_pop = sessionStorage.getItem("artists_popularity").split(',');

            var chart =  new CanvasJS.Chart("chartContainer", {
            theme: "dark1", // "light2", "dark1", "dark2"
            animationEnabled: true, // change to true		
            title:{
                text: "Artists- Popularity"
                },
                data: [
                {
                    // Change type to "bar", "area", "spline", "pie",etc.
                    type: "column",
                    dataPoints: [
                        { label: art_name[0],  y: parseInt(art_pop[0],10)},
                        { label: art_name[1], y: parseInt(art_pop[1],10)  },
                        { label: art_name[2], y: parseInt(art_pop[2],10)  },
                        { label: art_name[3],  y: parseInt(art_pop[3],10)  },
                        { label: art_name[4],  y: parseInt(art_pop[4],10)  },
                        { label: art_name[5],  y: parseInt(art_pop[5],10) },
                        { label: art_name[6], y: parseInt(art_pop[6],10)  },
                        { label: art_name[7], y: parseInt(art_pop[7],10)  },
                        { label: art_name[8],  y: parseInt(art_pop[8],10)  },
                        { label: art_name[9],  y: parseInt(art_pop[9],10)  }
                    ]
                }
                ]
            });
            chart.render();

            let fdds =  document.querySelector("div.canvasjs-chart-container a");
            fdds.setAttribute("style", "display:none;");
            
            document.getElementById("btn-download").addEventListener("click",function() {
            chart.exportChart({format: "png"});
            });

            document.getElementById("btn-download-svg").addEventListener("click",function() {
                chart.exportChart({format: "svg"});
            });

            deleteAllCookies();
            name = [];
            popularity = [];

            });

        document.getElementById("btn_top_genres").addEventListener("click", function () {

            if (!("genres_name" in sessionStorage)) {
                sessionStorage.setItem('genres_name',name);
            }
            if (sessionStorage.getItem("genres_popularity") == null) {
                sessionStorage.setItem('genres_popularity',popularity);
            }

            let gen_name = sessionStorage.getItem('genres_name').split(',');
            let gen_pop = sessionStorage.getItem("genres_popularity").split(',');

            var chart =  new CanvasJS.Chart("chartContainer", {
            theme: "dark1", // "light2", "dark1", "dark2"
            animationEnabled: true, // change to true		
            title:{
                text: "Genres - Popularity"
                },
                data: [
                {
                    // Change type to "bar", "area", "spline", "pie",etc.
                    type: "column",
                    dataPoints: [
                        { label: gen_name[0],  y: parseInt(gen_pop[0],10)},
                        { label: gen_name[1], y: parseInt(gen_pop[1],10)  },
                        { label: gen_name[2], y: parseInt(gen_pop[2],10)  },
                        { label: gen_name[3],  y: parseInt(gen_pop[3],10)  },
                        { label: gen_name[4],  y: parseInt(gen_pop[4],10)  },
                        { label: gen_name[5],  y: parseInt(gen_pop[5],10) },
                        { label: gen_name[6], y: parseInt(gen_pop[6],10)  },
                        { label: gen_name[7], y: parseInt(gen_pop[7],10)  },
                        { label: gen_name[8],  y: parseInt(gen_pop[8],10)  },
                        { label: gen_name[9],  y: parseInt(gen_pop[9],10)  }
                    ]
                }
                ]
            });
            chart.render();

            let fdds =  document.querySelector("div.canvasjs-chart-container a");
            fdds.setAttribute("style", "display:none;");
            
            document.getElementById("btn-download").addEventListener("click",function() {
            chart.exportChart({format: "png"});
            });

            document.getElementById("btn-download-svg").addEventListener("click",function() {
                chart.exportChart({format: "svg"});
            });

            deleteAllCookies();
            name = [];
            popularity = [];

            });

        document.getElementById("btn_groups").addEventListener("click", function(){
            let user_group = popularity;
            if (!("group_genres_name" in sessionStorage)) {
                sessionStorage.setItem('group_genres_name',popularity[0]);
            }

            if (!("all_genres_name" in sessionStorage)) {
                sessionStorage.setItem('all_genres_name',popularity[1]);
            }

            let group_gen_name = sessionStorage.getItem('group_genres_name').split(',');

            if(group_gen_name.length >1){ 

            document.getElementById("first_gen").innerHTML = group_gen_name[0];
            document.getElementById("sec_gen").innerHTML = group_gen_name[1];
            document.getElementById("thr_gen").innerHTML = group_gen_name[2];
            document.getElementById("four_gen").innerHTML = group_gen_name[3];
            document.getElementById("five_gen").innerHTML = group_gen_name[4];
            document.getElementById("six_gen").innerHTML = group_gen_name[5];
            document.getElementById("seven_gen").innerHTML = group_gen_name[6];
            document.getElementById("eight_gen").innerHTML = group_gen_name[7];
            document.getElementById("nine_gen").innerHTML = group_gen_name[8];
            document.getElementById("ten_gen").innerHTML = group_gen_name[9];
            }

            deleteAllCookies();
            name = [];
            popularity = [];

        })

        function makegraph(a,b){

            let track_name = a;
            let track_pop = b;
            let track_popularity = [];
            let track_nname = [];

            for (i = 0; i < track_pop.length; i ++){
                if(parseInt(track_pop[i],10) > 3) {
                    track_popularity.push(track_pop[i]);
                    track_nname.push(track_name[i]);
                }

            }

            track_pop = track_popularity;
            track_name = track_nname;
            

            var chart =  new CanvasJS.Chart("chartContainer", {
            theme: "dark1", // "light2", "dark1", "dark2"
            animationEnabled: true, // change to true		
            title:{
                text: "search top"
                },
                data: [
                {
                    // Change type to "bar", "area", "spline", "pie",etc.
                    type: "column",
                    dataPoints: [
                        { label: track_name[0],  y: parseInt(track_pop[0],10)},
                        { label: track_name[1], y: parseInt(track_pop[1],10)  },
                        { label: track_name[2], y: parseInt(track_pop[2],10)  },
                        { label: track_name[3],  y: parseInt(track_pop[3],10)  },
                        { label: track_name[4],  y: parseInt(track_pop[4],10)  },
                        { label: track_name[5],  y: parseInt(track_pop[5],10) },
                        { label: track_name[6], y: parseInt(track_pop[6],10)  },
                        { label: track_name[7], y: parseInt(track_pop[7],10)  },
                        { label: track_name[8],  y: parseInt(track_pop[8],10)  },
                        { label: track_name[9],  y: parseInt(track_pop[9],10)  }
                    ]
                }
                ]
            });
            chart.render();

            let fdds =  document.querySelector("div.canvasjs-chart-container a");
            fdds.setAttribute("style", "display:none;");
            
            document.getElementById("btn-download").addEventListener("click",function() {
            chart.exportChart({format: "png"});
            });

            document.getElementById("btn-download-svg").addEventListener("click",function() {
                chart.exportChart({format: "svg"});
            });

            deleteAllCookies();
        }

        function top_artists_name_cookies(){
            var name = [];
            var decodedCookie = decodeURIComponent(document.cookie);
            var ca = decodedCookie.split(';');

            for(var i = 0; i <ca.length; i++) {
                var c = ca[i];
                var split_c = c.split('=');
                name.push(split_c[0]);
            }
            return name;
        }

        function top_artists_popularity_cookies(){
            var popularity = [];
            var decodedCookie = decodeURIComponent(document.cookie);
            var ca = decodedCookie.split(';');

            for(var i = 0; i <ca.length; i++) {
                var c = ca[i];
                var split_c = c.split('=');
                popularity.push(split_c[1]);
            }
            return popularity;
        }
        
        function deleteAllCookies() {
            var cookies = document.cookie.split(";");

            for (var i = 0; i < cookies.length; i++) {
                var cookie = cookies[i];
                var eqPos = cookie.indexOf("=");
                var name = eqPos > -1 ? cookie.substr(0, eqPos) : cookie;
                document.cookie = name + "=;expires=Thu, 01 Jan 1970 00:00:00 GMT";
            }
        }

    </script>
</html>